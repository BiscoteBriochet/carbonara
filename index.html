<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbonara</title>
    <style>
        body {
            font-family: 'Minecraft', Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #588157;
        }

        h2 {
            color: #60a558;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }

        .form-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 2px solid #588157;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        button {
            padding: 10px 15px;
            background-color: #588157;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #60a558;
        }

        #result {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        .route-step {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #60a558;
        }

        .hsr-step {
            border-left: 4px solid #60a558;
        }

        .line-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            margin-right: 5px;
        }

        .hsr-badge {
            background-color: #094baf;
            position: relative;
        }

        .hsr-badge::after {
            content: "★";
            font-size: 10px;
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: gold;
            color: black;
            padding: 1px 3px;
            border-radius: 3px;
        }

        .admin-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
        }

        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .admin-controls button {
            flex: 1;
        }

        textarea {
            width: 100%;
            height: 300px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .transfer-station {
            font-weight: bold;
            color: #60a558;
        }

        .station-count {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .total-time {
            font-weight: bold;
            margin-top: 10px;
            font-size: 1.1em;
        }

        .help-text {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 15px;
            cursor: pointer;
            margin-right: 5px;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: #f5f5f5;
        }

        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .form-container {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>CARBONARA</h1>
        <h2 style="text-align: center;">A PESTO Train Router</h2>
        <h5 style="text-align: center;">Comprehensive And Rapid Browser for Organized Navigation And Route Assistance</h5>

        <div class="form-container">
            <div class="input-group">
                <label for="start-station">Start Station:</label>
                <select id="start-station"></select>
            </div>
            <div class="input-group">
                <label for="end-station">Destination Station:</label>
                <select id="end-station"></select>
            </div>
            <div>
                <button id="find-route">Find Route</button>
            </div>
        </div>

        <div id="result">
            <p>Select your starting point and destination to find the best route.</p>
        </div>
        <p>Total journey time does not take into account transfer times</p>
        <p>Outdated path? Go to "Configuration" then "Reset to Current Map" to update the network data.</p>
        <div class="admin-section">
            <h2>Information</h2>
            <div class="tabs">
                <div class="tab active" data-tab="help">Information</div>
                <div class="tab" data-tab="config">Configuration</div>
            </div>

            <div id="tab-help" class="tab-content">

                <h3>Map of the Network</h3>
                <p><a href="./map_18_03_2025.pdf" title="map_18_03_2025">Here</a> is a map of the HSR-LSR Network (pdf, last update: 18/03/2025)</p>
                <h3>How to get around?</h3>

                <h4>HSR Lines</h4>
                <p>HSR goes at 20bps, there will be 7 of them:</p>
                <ul>
                    <li>Yellow HSR aka PESTO HSR: a line that wraps around the world, and connects to every other HSR</li>
                    <li>Blue HSR: a line that serves mainly Western Europe</li>
                    <li>Green HSR: a line that serves mainly Eastern Europe</li>
                    <li>Purple HSR: a line that serves mainly Americas</li>
                    <li>Pink HSR: a line that serves mainly Middle-East</li>
                    <li>Red HSR: a line that serves mainly Asia and Oceania</li>
                    <li>Orange HSR: a line that serves mainly Africa</li>
                </ul>

                <h4>LSR Lines</h4>
                <p>LSR goes up to 16bps, the list of lines is available <a href="./lsr_18_03_2025.pdf" title="lsr_18_03_2025">here</a> (pdf, last update: 18/03/2025)</p>

                <h4>Other Methods of Transportation</h4>
                <ul>
                    <li>ALFREDO: Accelerated Lazy Flight, Ridiculously Energetic Displacement Operation (refer to <a href="https://discord.com/channels/1168009387122630669/1168009428671406200/1335308672640749690">this</a>)</li>
                    <li>End Portals: You can go in the End and get back to your spawnpoint. If you're far from Charleville-Mézières you can just break your bed, go in the End (or die) and tada you're at CVM</li>
                </ul>
                <h3>Other</h3>
                <p>We (PESTO) would appreciate if you told us:</p>
                <ul>
                    <li>If you built a line and it doesn't show up on the map or the train router</li>
                    <li>If you plan on building a line (so we can add it in the form of a dotted line on the map)</li>
                    <li>If you have a question :)</li>
                </ul>
                <p>Please note that this router takes in account lines that are planned but not built. To avoid confusion, chunks of itinerary that aren't built are shown taking an hour.</p>
                <p>For the moment, it only includes European LSR. I'm aware there is some LSR in Americas and Australia, I'll add them soon-ish™</p>
                <!----><button id="show-config" class="tab" style="display: block; margin-top: 15px;">Switch to Configuration</button>
            </div>

            <div id="tab-config" class="tab-content" style="display: none;">
                <div class="admin-controls">
                    <button id="save-data">Save Network Data</button>
                    <button id="reset-default">Reset to Current Map</button>
                </div>
                <textarea id="network-data"></textarea>
            </div>
        </div>
    </div>

    <script>
        const root = 0;
        const parent = i => ((i + 1) >>> 1) - 1;
        const left = i => (i << 1) + 1;
        const right = i => (i + 1) << 1;

        class PriorityQueue {
            constructor(comparator = (a, b) => a > b) {
                this._heap = [];
                this._comparator = comparator;
            }
            size() {
                return this._heap.length;
            }
            isEmpty() {
                return this.size() == 0;
            }
            peek() {
                return this._heap[root];
            }
            push(...values) {
                values.forEach(value => {
                    this._heap.push(value);
                    this._siftUp();
                });
                return this.size();
            }
            pop() {
                const poppedValue = this.peek();
                const bottom = this.size() - 1;
                if (bottom > root) {
                    this._swap(root, bottom);
                }
                this._heap.pop();
                this._siftDown();
                return poppedValue;
            }
            replace(value) {
                const replacedValue = this.peek();
                this._heap[root] = value;
                this._siftDown();
                return replacedValue;
            }
            _greater(i, j) {
                return this._comparator(this._heap[i], this._heap[j]);
            }
            _swap(i, j) {
                [this._heap[i], this._heap[j]] = [this._heap[j], this._heap[i]];
            }
            _siftUp() {
                let node = this.size() - 1;
                while (node > root && this._greater(node, parent(node))) {
                    this._swap(node, parent(node));
                    node = parent(node);
                }
            }
            _siftDown() {
                let node = root;
                while (
                    (left(node) < this.size() && this._greater(left(node), node)) ||
                    (right(node) < this.size() && this._greater(right(node), node))
                ) {
                    let maxChild = (right(node) < this.size() && this._greater(right(node), left(node))) ? right(node) : left(node);
                    this._swap(node, maxChild);
                    node = maxChild;
                }
            }
        }

        // Default example network data with both LSR and HSR
        const defaultNetworkData = {
            lines: [
                {
                    id: "lsr1",
                    name: "Brighton Red Line",
                    colour: "#ed1c2a",
                    type: "lsr"
                },
                {
                    id: "lsr3",
                    name: "Big Bridge",
                    colour: "#f59fb3",
                    type: "lsr"
                },
                {
                    id: "lsr4",
                    name: "Vistula Express Line",
                    colour: "#080e5c",
                    type: "lsr"
                },
                {
                    id: "lsr5",
                    name: "Tatra Line",
                    colour: "#f78f4b",
                    type: "lsr"
                },
                {
                    id: "lsr6",
                    name: "Baltic Line",
                    colour: "#ed1c2a",
                    type: "lsr"
                },
                {
                    id: "lsr7",
                    name: "Birmingham Yellow Line",
                    colour: "#ffcd02",
                    type: "lsr"
                },
                {
                    id: "lsr8",
                    name: "Newcastle Green Line",
                    colour: "#77c696",
                    type: "lsr"
                },
                {
                    id: "lsr9",
                    name: "Atlantic Line",
                    colour: "#87d3df",
                    type: "lsr"
                },
                {
                    id: "lsr10",
                    name: "LSR 10",
                    colour: "#662c91",
                    type: "lsr"
                },
                {
                    id: "lsr11",
                    name: "Dźwina Line",
                    colour: "#4c90cd",
                    type: "lsr"
                },
                {
                    id: "lsr12",
                    name: "Vistula Line",
                    colour: "#008c5a",
                    type: "lsr"
                },
                {
                    id: "lsr13",
                    name: "Carpathia Line",
                    colour: "#e0b03b",
                    type: "lsr"
                },
                {
                    id: "lsr14",
                    name: "Dnieper Line",
                    colour: "#ffcd02",
                    type: "lsr"
                },
                {
                    id: "lsr15",
                    name: "LSR 15",
                    colour: "#b80b4b",
                    type: "lsr"
                },
                {
                    id: "lsr16",
                    name: "LSR 16",
                    colour: "#c5a3cd",
                    type: "lsr"
                },
                {
                    id: "lsr30",
                    name: "Big Bridge Zugdidi Branch",
                    colour: "#b80b4b",
                    type: "lsr"
                },
                {
                    id: "lsr31",
                    name: "Big Bridge Thessaloniki Branch",
                    colour: "#bb4a9b",
                    type: "lsr"
                },
                {
                    id: "lsr32",
                    name: "Big Bridge Istanbul Branch",
                    colour: "#c5a3cd",
                    type: "lsr"
                },
                {
                    id: "lsr33",
                    name: "Big Bridge Mequinenza Branch",
                    colour: "#b80b4b",
                    type: "lsr"
                },
                {
                    id: "lsr50",
                    name: "LSR 50",
                    colour: "#ed1c2a",
                    type: "lsr"
                },
                {
                    id: "lsr51",
                    name: "LSR 51",
                    colour: "#080e5c",
                    type: "lsr"
                },
                {
                    id: "lsr999",
                    name: "Miscellaneous Connections",
                    colour: "#79edba",
                    type: "lsr"
                },
                {
                    id: "hsr1",
                    name: "Blue HSR",
                    colour: "#4c90cd",
                    type: "hsr"
                },
                {
                    id: "hsr2",
                    name: "Green HSR",
                    colour: "#30a442",
                    type: "hsr"
                }
            ],
            stations: [
                {
                    name: "Queen's Cross"
                },
                {
                    name: "Brighton"
                },
                {
                    name: "Southampton"
                },
                {
                    name: "Plymouth"
                },
                {
                    name: "Charleville-Mézières"
                },
                {
                    name: "West Mediterranean"
                },
                {
                    name: "Catania"
                },
                {
                    name: "Antalya"
                },
                {
                    name: "Rasht"
                },
                {
                    name: "Baikonur End Portal"
                },
                {
                    name: "Gdańsk"
                },
                {
                    name: "Warsaw Central"
                },
                {
                    name: "Katowice"
                },
                {
                    name: "Košice"
                },
                {
                    name: "Belgrade"
                },
                {
                    name: "Thessaloniki"
                },
                {
                    name: "Kiel"
                },
                {
                    name: "Szczecin"
                },
                {
                    name: "Królewiec"
                },
                {
                    name: "Kaunas"
                },
                {
                    name: "Riga"
                },
                {
                    name: "Tallinn"
                },
                {
                    name: "Birmingham"
                },
                {
                    name: "Liverpool"
                },
                {
                    name: "Isle of Man"
                },
                {
                    name: "Newcastle"
                },
                {
                    name: "Rennes"
                },
                {
                    name: "La Rochelle"
                },
                {
                    name: "Bordeaux"
                },
                {
                    name: "Pyrenees"
                },
                {
                    name: "Mequinenza"
                },
                {
                    name: "Gesalibar"
                },
                {
                    name: "Brest (FR)"
                },
                {
                    name: "Étampes"
                },
                {
                    name: "Reims"
                },
                {
                    name: "Düsseldorf"
                },
                {
                    name: "Brest (BY)"
                },
                {
                    name: "Helsinki"
                },
                {
                    name: "Bydgoszcz"
                },
                {
                    name: "Płock"
                },
                {
                    name: "Lublin"
                },
                {
                    name: "Carpathia"
                },
                {
                    name: "Kyiv"
                },
                {
                    name: "Odessa"
                },
                {
                    name: "Romanian Slime Farm"
                },
                {
                    name: "Istanbul"
                },
                {
                    name: "Tirana"
                },
                {
                    name: "Bari"
                },
                {
                    name: "Zugdidi"
                },
                {
                    name: "Zagreb"
                },
                {
                    name: "Ljubljana"
                },
                {
                    name: "Venice"
                },
                {
                    name: "Sarajevo"
                },
                {
                    name: "Podgorica"
                },
                {
                    name: "Pristina"
                },
                {
                    name: "Amsterdam Centraal"
                },
                {
                    name: "Karlsruhe"
                },
            ],
            connections: [
                {
                    from: "Queen's Cross",
                    to: "Brighton",
                    line_id: "lsr1",
                    time: 40
                },
                {
                    from: "Brighton",
                    to: "Southampton",
                    line_id: "lsr1",
                    time: 20
                },
                {
                    from: "Southampton",
                    to: "Plymouth",
                    line_id: "lsr1",
                    time: 70
                },
                {
                    from: "Charleville-Mézières",
                    to: "West Mediterranean",
                    line_id: "lsr3",
                    time: 115
                },
                {
                    from: "West Mediterranean",
                    to: "Catania",
                    line_id: "lsr3",
                    time: 185
                },
                {
                    from: "Catania",
                    to: "Antalya",
                    line_id: "lsr3",
                    time: 205
                },
                {
                    from: "Antalya",
                    to: "Rasht",
                    line_id: "lsr3",
                    time: 245
                },
                {
                    from: "Rasht",
                    to: "Baikonur End Portal",
                    line_id: "lsr3",
                    time: 300
                },
                {
                    from: "Gdańsk",
                    to: "Warsaw Central",
                    line_id: "lsr4",
                    time: 65
                },
                {
                    from: "Warsaw Central",
                    to: "Katowice",
                    line_id: "lsr5",
                    time: 30
                },
                {
                    from: "Katowice",
                    to: "Košice",
                    line_id: "lsr5",
                    time: 40
                },
                {
                    from: "Košice",
                    to: "Belgrade",
                    line_id: "lsr5",
                    time: 55
                },
                {
                    from: "Belgrade",
                    to: "Thessaloniki",
                    line_id: "lsr5",
                    time: 85
                },
                {
                    from: "Kiel",
                    to: "Szczecin",
                    line_id: "lsr6",
                    time: 70
                },
                {
                    from: "Szczecin",
                    to: "Gdańsk",
                    line_id: "lsr6",
                    time: 65
                },
                {
                    from: "Gdańsk",
                    to: "Królewiec",
                    line_id: "lsr6",
                    time: null
                },
                {
                    from: "Królewiec",
                    to: "Kaunas",
                    line_id: "lsr6",
                    time: null
                },
                {
                    from: "Kaunas",
                    to: "Riga",
                    line_id: "lsr6",
                    time: null
                },
                {
                    from: "Riga",
                    to: "Tallinn",
                    line_id: "lsr6",
                    time: null
                },
                {
                    from: "Queen's Cross",
                    to: "Birmingham",
                    line_id: "lsr7",
                    time: 45
                },
                {
                    from: "Birmingham",
                    to: "Liverpool",
                    line_id: "lsr7",
                    time: 30
                },
                {
                    from: "Liverpool",
                    to: "Isle of Man",
                    line_id: "lsr7",
                    time: 40
                },
                {
                    from: "Southampton",
                    to: "Birmingham",
                    line_id: "lsr8",
                    time: 20
                },
                {
                    from: "Birmingham",
                    to: "Newcastle",
                    line_id: "lsr8",
                    time: 30
                },
                {
                    from: "Southampton",
                    to: "Rennes",
                    line_id: "lsr9",
                    time: 45
                },
                {
                    from: "Rennes",
                    to: "La Rochelle",
                    line_id: "lsr9",
                    time: null
                },
                {
                    from: "La Rochelle",
                    to: "Bordeaux",
                    line_id: "lsr9",
                    time: null
                },
                {
                    from: "Bordeaux",
                    to: "Pyrenees",
                    line_id: "lsr9",
                    time: null
                },
                {
                    from: "Pyrenees",
                    to: "Mequinenza",
                    line_id: "lsr9",
                    time: null
                },
                {
                    from: "Brest (FR)",
                    to: "Rennes",
                    line_id: "lsr10",
                    time: null
                },
                {
                    from: "Rennes",
                    to: "Étampes",
                    line_id: "lsr10",
                    time: null
                },
                {
                    from: "Étampes",
                    to: "Reims",
                    line_id: "lsr10",
                    time: null
                },
                {
                    from: "Reims",
                    to: "Charleville-Mézières",
                    line_id: "lsr10",
                    time: null
                },
                {
                    from: "Charleville-Mézières",
                    to: "Düsseldorf",
                    line_id: "lsr10",
                    time: null
                },
                {
                    from: "Düsseldorf",
                    to: "Kiel",
                    line_id: "lsr10",
                    time: null
                },
                {
                    from: "Warsaw Central",
                    to: "Brest (BY)",
                    line_id: "lsr11",
                    time: 40
                },
                {
                    from: "Brest (BY)",
                    to: "Riga",
                    line_id: "lsr11",
                    time: 85
                },
                {
                    from: "Riga",
                    to: "Tallinn",
                    line_id: "lsr11",
                    time: 30
                },
                {
                    from: "Tallinn",
                    to: "Helsinki",
                    line_id: "lsr11",
                    time: 20
                },
                {
                    from: "Gdańsk",
                    to: "Bydgoszcz",
                    line_id: "lsr12",
                    time: null
                },
                {
                    from: "Bydgoszcz",
                    to: "Płock",
                    line_id: "lsr12",
                    time: null
                },
                {
                    from: "Płock",
                    to: "Warsaw Central",
                    line_id: "lsr12",
                    time: null
                },
                {
                    from: "Warsaw Central",
                    to: "Lublin",
                    line_id: "lsr12",
                    time: null
                },
                {
                    from: "Lublin",
                    to: "Katowice",
                    line_id: "lsr12",
                    time: null
                },
                {
                    from: "Warsaw Central",
                    to: "Carpathia",
                    line_id: "lsr13",
                    time: null
                },
                {
                    from: "Warsaw Central",
                    to: "Brest (BY)",
                    line_id: "lsr14",
                    time: 40
                },
                {
                    from: "Brest (BY)",
                    to: "Kyiv",
                    line_id: "lsr14",
                    time: 105
                },
                {
                    from: "Kyiv",
                    to: "Odessa",
                    line_id: "lsr14",
                    time: 50
                },
                {
                    from: "Thessaloniki",
                    to: "Tirana",
                    line_id: "lsr15",
                    time: 45
                },
                {
                    from: "Tirana",
                    to: "Bari",
                    line_id: "lsr16",
                    time: 50
                },
                {
                    from: "Bari",
                    to: "Catania",
                    line_id: "lsr16",
                    time: 80
                },
                {
                    from: "Rasht",
                    to: "Zugdidi",
                    line_id: "lsr30",
                    time: 185
                },
                {
                    from: "Antalya",
                    to: "Istanbul",
                    line_id: "lsr32",
                    time: 70
                },
                {
                    from: "West Mediterranean",
                    to: "Mequinenza",
                    line_id: "lsr33",
                    time: 65
                },
                {
                    from: "Belgrade",
                    to: "Zagreb",
                    line_id: "lsr50",
                    time: 145
                },
                {
                    from: "Zagreb",
                    to: "Ljubljana",
                    line_id: "lsr50",
                    time: 45
                },
                {
                    from: "Ljubljana",
                    to: "Venice",
                    line_id: "lsr50",
                    time: 65
                },
                {
                    from: "Belgrade",
                    to: "Sarajevo",
                    line_id: "lsr51",
                    time: 100
                },
                {
                    from: "Sarajevo",
                    to: "Podgorica",
                    line_id: "lsr51",
                    time: 65
                },
                {
                    from: "Podgorica",
                    to: "Pristina",
                    line_id: "lsr51",
                    time: 30
                },
                {
                    from: "Pristina",
                    to: "Tirana",
                    line_id: "lsr51",
                    time: 65
                },
                {
                    from: "Odessa",
                    to: "Romanian Slime Farm",
                    line_id: "lsr32",
                    time: 35
                },
                {
                    from: "Romanian Slime Farm",
                    to: "Istanbul",
                    line_id: "lsr32",
                    time: 95
                },
                {
                    from: "Charleville-Mézières",
                    to: "Karlsruhe",
                    line_id: "lsr999",
                    time: 110
                },
                {
                    from: "Mequinenza",
                    to: "Gesalibar",
                    line_id: "lsr999",
                    time: 110
                },
                {
                    from: "Charleville-Mézières",
                    to: "Amsterdam Centraal",
                    line_id: "hsr1",
                    time: 40
                },
                {
                    from: "Charleville-Mézières",
                    to: "Rennes",
                    line_id: "hsr1",
                    time: 85
                },
                {
                    from: "Charleville-Mézières",
                    to: "Queen's Cross",
                    line_id: "hsr1",
                    time: 65
                },
                {
                    from: "Amsterdam Centraal",
                    to: "Rennes",
                    line_id: "hsr1",
                    time: 85
                },
                {
                    from: "Amsterdam Centraal",
                    to: "Queen's Cross",
                    line_id: "hsr1",
                    time: 65
                },
                {
                    from: "Rennes",
                    to: "Queen's Cross",
                    line_id: "hsr1",
                    time: 60
                },
                {
                    from: "Amsterdam Centraal",
                    to: "Warsaw Central",
                    line_id: "hsr2",
                    time: 165
                }
            ]
        };

        let networkData = JSON.parse(JSON.stringify(defaultNetworkData));

        // DOM elements
        const startSelect = document.getElementById('start-station');
        const endSelect = document.getElementById('end-station');
        const findRouteBtn = document.getElementById('find-route');
        const resultDiv = document.getElementById('result');
        const networkDataTextarea = document.getElementById('network-data');
        const saveDataBtn = document.getElementById('save-data');
        const resetDefaultBtn = document.getElementById('reset-default');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const showConfigBtn = document.getElementById('show-config');

        // Initialize the app
        function init() {
            loadNetworkData();
            populateStations();
            bindEvents();
        }

        // Load network data from localStorage or use default
        function loadNetworkData() {
            const savedData = localStorage.getItem('minecraftTrainNetwork');
            if (savedData) {
                try {
                    networkData = JSON.parse(savedData);
                } catch (e) {
                    console.error("Error parsing saved network data:", e);
                    networkData = JSON.parse(JSON.stringify(defaultNetworkData));
                }
            }
            networkDataTextarea.value = JSON.stringify(networkData, null, 2);
        }

        // Get all unique stations from all lines (both LSR and HSR)
        function getAllStations() {
            const stations = new Set();

            networkData.stations.forEach(station => {
                stations.add(station.name);
            })

            return Array.from(stations).sort((a, b) => a.localeCompare(b));
        }

        // Populate station dropdowns
        function populateStations() {
            const stations = getAllStations();

            startSelect.innerHTML = '';
            endSelect.innerHTML = '';

            stations.forEach(station => {
                const startOption = document.createElement('option');
                startOption.value = station;
                startOption.textContent = station;

                const endOption = document.createElement('option');
                endOption.value = station;
                endOption.textContent = station;

                startSelect.appendChild(startOption);
                endSelect.appendChild(endOption);
            });
        }

        // Bind event listeners
        function bindEvents() {
            findRouteBtn.addEventListener('click', findAndDisplayRoute);
            saveDataBtn.addEventListener('click', saveNetworkData);
            resetDefaultBtn.addEventListener('click', resetToDefaultData);
            showConfigBtn.addEventListener('click', () => switchTab('config'));

            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.getAttribute('data-tab'));
                });
            });
        }

        // Switch between tabs
        function switchTab(tabId) {
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            tabContents.forEach(content => {
                if (content.id === `tab-${tabId}`) {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            });
        }

        // Save network data to localStorage
        function saveNetworkData() {
            try {
                const newData = JSON.parse(networkDataTextarea.value);
                networkData = newData;
                localStorage.setItem('minecraftTrainNetwork', JSON.stringify(networkData));
                populateStations();
                alert("Network data saved successfully!");
            } catch (e) {
                alert("Error: Invalid JSON format. Please check your data.");
                console.error(e);
            }
        }

        // Reset to default network data
        function resetToDefaultData() {
            if (confirm("Are you sure you want to reset to the example network data? This will erase your current configuration.")) {
                networkData = JSON.parse(JSON.stringify(defaultNetworkData));
                networkDataTextarea.value = JSON.stringify(networkData, null, 2);
                localStorage.setItem('minecraftTrainNetwork', JSON.stringify(networkData));
                populateStations();
                alert("Reset to example network data.");
            }
        }

        // Find and display the optimal route
        function findAndDisplayRoute() {
            const startStation = startSelect.value;
            const endStation = endSelect.value;

            if (startStation === endStation) {
                resultDiv.innerHTML = "<p>Start and destination stations are the same.</p>";
                return;
            }

            const route = findRoute(startStation, endStation);
            displayRoute(route);
        }

        // Find the optimal route between two stations
        function findRoute(start, end) {
            const graph = {};

            networkData.stations.forEach(station => {
                const neighbours = [];

                networkData.connections.forEach(({ from, to, line_id, time }) => {
                    if (from === station.name) neighbours.push({ line_id, destination: to, time });
                    if (to === station.name) neighbours.push({ line_id, destination: from, time });
                });

                graph[station.name] = neighbours;
            })

            // Use Dijkstra's algorithm to find the shortest path
            const { distances, previous } = dijkstra(graph, start);

            // If there's no path to the destination
            let minNode = null;
            let minTime = Infinity;

            for (let neighbour of graph[end]) {
                if (distances[`${end}-${neighbour.line_id}`] < minTime) {
                    minTime = distances[`${end}-${neighbour.line_id}`];
                    minNode = { destination: end, line_id: neighbour.line_id };
                }
            }

            if (minTime === Infinity) return null;

            // Reconstruct the path
            const path = [{ line_id: minNode.line_id, destination: minNode.destination, time: -1 }];
            let currentNode = minNode;

            while (currentNode.destination !== start) {
                const { station: prevStation, line_id: prevLineID, time: prevTime } = previous[`${currentNode.destination}-${currentNode.line_id}`];
                path.push({ line_id: prevLineID, destination: prevStation, time: prevTime });
                currentNode = { destination: prevStation, line_id: prevLineID };
            }

            path.reverse();

            // Convert the path to a route with train lines
            return convertPathToRoute(path);
        }

        // Dijkstra's algorithm implementation
        function dijkstra(graph, start) {
            const distances = {};
            const previous = {};
            const pq = new PriorityQueue((a, b) => distances[`${a.destination}-${a.line_id}`] < distances[`${b.destination}-${b.line_id}`]);
            const visited = new Set();

            // Initialize distances and add all nodes to the unvisited set
            Object.values(graph).forEach((neighbours) => {
                neighbours.forEach(({ line_id, destination }) => {
                    const node = { destination, line_id };
                    distances[`${destination}-${line_id}`] = destination === start ? 0 : Infinity;
                    previous[`${destination}-${line_id}`] = null;

                    if (destination === start) pq.push(node);
                })
            })

            while (!pq.isEmpty()) {
                // Find the node with the minimum distance
                const minNode = pq.pop();

                const { destination: minStation, line_id: minLine } = minNode;

                // If the minimum distance is infinity, there are no more reachable nodes
                if (distances[`${minStation}-${minLine}`] === Infinity) break;

                visited.add(minNode);

                // Update distances to adjacent nodes
                graph[minStation].forEach(({ line_id, destination, time }) => {
                    if (time !== null && !visited.has({ destination, line_id })) {
                        let alt = distances[`${minStation}-${minLine}`] + time;

                        if (line_id !== minLine) alt += 0.1;

                        if (alt < distances[`${destination}-${line_id}`]) {
                            distances[`${destination}-${line_id}`] = alt;
                            previous[`${destination}-${line_id}`] = { station: minStation, line_id: minLine, time };
                            pq.push({ destination, line_id });
                        }
                    }
                });
            }

            return { distances, previous };
        }

        // Convert a path of stations to a route with train lines
        function convertPathToRoute(path) {
            // convert path to route
            route = [];


            for (let i = 0; i < path.length - 1; ++i) {
                const { destination: from, time } = path[i];
                const { line_id, destination: to } = path[i + 1];
                const line = networkData.lines.find(l => l.id === line_id);

                if (route.length > 0 && route[route.length - 1].lineName === line.name) {
                    const lastSegment = route[route.length - 1];
                    lastSegment.to = to;
                    lastSegment.stops.push(to);

                    if (line.type === "lsr") {
                        lastSegment.time += time;
                        lastSegment.segments.push({ from, to, line_id, time });
                    }
                } else {
                    if (line.type === "lsr") {
                        route.push({
                            from,
                            to,
                            lineName: line.name,
                            lineColour: line.colour,
                            type: "lsr",
                            stops: [from, to],
                            time,
                            segments: [{ from, to, line_id, time }]
                        });
                    } else { // HSR
                        route.push({
                            from,
                            to,
                            lineName: line.name,
                            lineColour: line.colour,
                            type: "hsr",
                            stops: [from, to],
                            time,
                            segments: []
                        });
                    }
                }
            }

            return route;
        }

        // Format time (seconds to minutes and seconds)
        function formatTime(seconds) {
            if (seconds < 60) {
                return `${seconds} seconds`;
            }

            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;

            if (sec === 0) {
                return `${min} minute${min !== 1 ? 's' : ''}`;
            }

            return `${min} minute${min !== 1 ? 's' : ''} ${sec} second${sec !== 1 ? 's' : ''}`;
        }

        // Display the route
        function displayRoute(route) {
            if (!route) {
                resultDiv.innerHTML = "<p>No route found between these stations.</p>";
                return;
            }

            let totalTime = 0;
            let html = "<h2>Your Route</h2>";

            route.forEach((segment, index) => {
                totalTime += segment.time;

                const isHSR = segment.type === "hsr";
                const hsrClass = isHSR ? "hsr-step" : "";
                const hsrBadgeClass = isHSR ? "hsr-badge" : "";

                html += `<div class="route-step ${hsrClass}">`;
                html += `<div><span class="line-badge ${hsrBadgeClass}" style="background-color: ${segment.lineColour}">${segment.lineName}</span>`;

                if (index === 0) {
                    html += `From <strong>${segment.from}</strong>`;
                } else {
                    html += `Continue from <strong class="transfer-station">${segment.from}</strong>`;
                }

                if (index === route.length - 1) {
                    html += ` to <strong>${segment.to}</strong>`;
                } else {
                    html += ` to <strong class="transfer-station">${segment.to}</strong>`;
                }

                html += `</div>`;

                // For LSR lines with intermediate stations
                if (segment.type === "lsr" && segment.stops.length > 2) {
                    html += `<div class="station-count">Pass through: ${segment.stops.slice(1, -1).join(", ")}</div>`;
                }

                // For HSR lines
                if (segment.type === "hsr") {
                    html += `<div class="station-count"><strong>Express direct connection</strong></div>`;
                }

                // Show detailed segment times for LSR
                if (segment.type === "lsr") {
                    html += `<div class="station-count">`;
                    segment.segments.forEach(seg => {
                        html += `${seg.from} to ${seg.to}: ${formatTime(seg.time)}<br>`;
                    });
                    html += `</div>`;
                }

                html += `<div class="station-count">Total: ${formatTime(segment.time)}`;

                if (segment.type === "lsr") {
                    html += ` (${segment.segments.length} stops)`;
                }

                html += `</div>`;
                html += `</div>`;

                if (index < route.length - 1) {
                    html += `<div class="route-step" style="padding-left: 20px">Transfer at <strong class="transfer-station">${segment.to}</strong> to <span class="line-badge ${route[index + 1].type === 'hsr' ? 'hsr-badge' : ''}" style="background-color: ${route[index + 1].lineColour}">${route[index + 1].lineName}</span></div>`;
                }
            });

            html += `<div class="total-time">Total journey time: ${formatTime(totalTime)}</div>`;

            resultDiv.innerHTML = html;
        }

        // Initialize the app on page load
        init();
    </script>
</body>

</html>
